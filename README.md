# Andela Solar Project

Andela Solar is a backend web application created in a hurry by a team on the bench at Andela. This application collects 
energy analytics data for solar panels every hour.

**Notes:**

- The project accepts data for registered panels only, and to register a panel, a serial number along with latitude and
longitude is required. The serial number must be exactly 16 characters in length (for ex. AAAA1111BBBB2222); latitude 
and longitude should contain 6 decimal places and must have valid values within latitude range (-90 to 90) and longitude
range (-180 to 180) respectively.

- The frontend application is excluded from the current scope. It is a separate, fully-functional application handled 
by another team, and we do not want to modify it.

**Tasks:**

1. The frontend team want to display a panel's historical data in a chart, in which each point represents electricity 
generated by this panel each day [sum, min, max, average of hourly kilowatt values], up to the end of the previous day.
Your goal is to implement the backend part of this task. The API specifications are already there in the code as agreed 
with the frontend team.

2. There are a few bugs in the application that you need to fix. 

3. Increase unit test coverage to reach at least 90%.

4. Update this README to add a description of how your implementation takes into consideration the handling of massive 
requests for historical charts, because each time data is aggregated from hourly records to generate daily data, the 
operation overloads the server. Please describe how your solution optimizes this operation without necessarily adding 
new servers.

5. Implement CI/CD pipeline for Andela Solar so that anytime code is pushed to a feature or the master branch, it triggers
a deployment of the project to a PaaS like Heroku. Also, describe how you'd upload your code coverage report to a service.

## Task Implementation
```php
//  ...
public function index(Request $request)
{
    $panel = Panel::select('id')->where('serial', $request->panel_serial)->first();

    $oneEs = DB::table('one_hour_electricities')
        ->select('kilowatts')
        ->where('panel_id', $panel->id)
        ->whereDate('hour', Carbon::today()->format("Y-m-d"))
        ->get();

    return response()->json([
        'day' => Carbon::today()->format("Y-m-d"),
        'sum' => (double) $oneEs->sum($kw = 'kilowatts'),
        'min' => (double) $oneEs->min($kw),
        'max' => (double) $oneEs->max($kw),
        'average' => (double) $oneEs->avg($kw),
    ], 200);
}
```
##### Explanation
- First fetch the `$panel` instance using it's serial number from the incoming `$request`
- Using `QueryBuilder`s, build a query to fetch all `OneHourElectricities` belong to the `$panel`, and who have `hour` values, for the current day, i.e after the end of the previous day.
- Only `select` the `kilowatts` attribute, which is to be used the required computations.
- This is a better approach as it does not fetch all information about the models, including information that we don't need for the computation of the report.
- The result of executing the query, results in a `Collection`, and then the `min`, `max`, `sum` and `avg` values are computed on the collection itself.
- The report data is returned as JSON to the requesting client, and the response status is 200.

##### Other tasks
- Fixed some bugs, including validation rules for creating `Panel`s.
- Implemented CI/CD with TravisCI and Heroku. I had to re-create this project on a public repo [here](https://github.com/elchroy/solar). For any branch that is pushed and a PR raised, Heroku creates a ReviewApp. However, I didn't include the environment variables for this. 
- [![Build Status](https://travis-ci.org/elchroy/solar.svg?branch=roy/ft-one-day-panel-electricity-history)](https://travis-ci.org/elchroy/solar) *The badge is for the `roy/ft-one-day-panel-electricity-history` branch.*
- Attained 100% test coverage. I used XDebug for local coverage reporting, and Coveralls for online coverage reporting. [![Coverage Status](https://coveralls.io/repos/github/elchroy/solar/badge.svg?branch=roy%2Fft-one-day-panel-electricity-history)](https://coveralls.io/github/elchroy/solar?branch=roy%2Fft-one-day-panel-electricity-history)


## Pre-requisites:

- PHP >= 7
- Laravel >= 5.6
- MySQL >= 5.6
- Xdebug

## Setup instructions:

- Add your local database password to the .env file.

- Create your database using your prefered MySQL client

- In the Terminal / Command Line, navigate to this directory (The directory containing README.md) and run the following commands:

```bash
composer install
php artisan migrate
php artisan serve
```

- You can then access the api using your preferred tool (Postman, Curl, etc).

## Testing:

- Add your local database password to the .env.testing file.

- Create your testing database using your prefered MySQL client

- In the Terminal / Command Line, navigate to this directory (The directory containing README.md) and run the following commands:

```bash
composer install
php artisan migrate
php artisan serve
```

## Evaluation:

Your work will be evaluated based on the following criteria;

- Implementation of new feature
- Bug fixes
- Unit test coverage
- Continuous integration/deployment implementation
- Performance and the scalability of the project
